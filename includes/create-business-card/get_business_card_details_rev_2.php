<?phprequire_once __DIR__ . '/../absolute_database_config.php';include_once(__DIR__ . '/../view-business-card/models.php');class Settings{	public $requested_setting;	public $settings_type;	public $settings_blob;	public function __construct()	{		$this->requested_setting = FALSE;		$this->settings_type = "";		//$this->settings_blob = FALSE;	}}$user_id = $_SESSION[ "user_id" ];function CGetSetting( $card_id, $card_type, $setting_description, $conn ){	$settings_to_return = new Settings();	$search_term = "";	$query = "";	$skip = FALSE;	if ( $setting_description == "visible_in_search" )	{		if ( $card_type == "Personal" || $card_type == "Corporate" )		{			$search_term = "global_search";			$query = sprintf( "SELECT * FROM personal_card_setting WHERE card_id = '%s'", $card_id );		}		elseif ( $card_type == "Professional" || $card_type == "Product" )		{			$search_term = "visible_pp_search";			$query = sprintf( "SELECT * FROM professional_card_setting WHERE card_id = '%s'", $card_id );		}	}	elseif ( $setting_description == "mutual_contacts" )	{		if ( $card_type == "Personal" || $card_type == "Corporate" )		{			$search_term = "seen_in_user_folder";			$query = sprintf( "SELECT * FROM personal_card_setting WHERE card_id = '%s'", $card_id );		}		elseif ( $card_type == "Professional" || $card_type == "Product" )		{			$query = sprintf( "SELECT * FROM professional_card_setting WHERE card_id = '%s'", $card_id );			$settings_to_return->requested_setting = TRUE;			$skip = TRUE;		}	}	$card_type_result = mysqli_query( $conn, $query );	//print_r($card_type_result);	if ( !$card_type_result )	{		//panic	}	$global_search = "";	while ( $type_row = mysqli_fetch_array( $card_type_result ) )	{		if ( !$skip )		{			$global_search = $type_row[ $search_term ];		}		$settings_to_return->settings_blob = $type_row;	}	if ( $global_search == "1" )	{		$settings_to_return->requested_setting = TRUE;	}	elseif ( $global_search == "0" )	{		//all good, just not allowed to show in search		$settings_to_return->requested_setting = FALSE;	}	else	{		//panic!! (golang style)		//throw exception	}	return $settings_to_return;}$orientation = 'landscape';$card_id = $_REQUEST[ 'card_id' ];if ( !isset( $_REQUEST[ 'card_id' ] ) ){	return;}$query = "select         u.user_id,        u.title,        u.last_name,        u.first_name,        u.phone,        u.mobile,        u.email_address,        u.password,        u.website_link,        u.additional_info,        u.personal_address_id,        u.company_name,        u.department_name,        u.position,        u.corporate_code,        u.company_address_id,        u.company_phone,        u.company_mobile,        u.company_email_address,        u.company_website_link,        pa.address_1 as personal_address_1,        pa.address_2 as personal_address_2,        pa.city as personal_city,        pa.country_id as personal_country,        pa.post_code as personal_post_code,        ca.address_1 as company_address_1,        ca.address_2 as company_address_2,        ca.city as company_city,        ca.country_id as company_country,        ca.post_code as company_post_code,        c.card_type,        c.card_name,        c.distributed_brand,        cd.landscape,        cd.canvas_back,        cd.canvas_front,        cd.widgets_front,        cd.widgets_back,        cd.links_front,        cd.links_back        from card c        inner join card_data cd on c.card_id = cd.card_id        inner join user u on u.user_id = c.user_id and c.card_id = cd.card_id        left join address pa on u.personal_address_id = pa.address_id        left join address ca on u.company_address_id = ca.address_id        WHERE u.user_id != '" . $_SESSION[ 'user_id' ] . "'         AND cd.card_id = '" . $card_id . "'";$bcard = mysqli_query( $conn, $query );while ( $row = mysqli_fetch_array( $bcard ) ){	$title = $row[ 'title' ];	$last_name = $row[ 'last_name' ];	$first_name = $row[ 'first_name' ];	$phone = $row[ 'phone' ];	$mobile = $row[ 'mobile' ];	$email_address = $row[ 'email_address' ];	$website_link = $row[ 'website_link' ];	$personal_address_1 = $row[ 'personal_address_1' ];	$personal_address_2 = $row[ 'personal_address_2' ];	$personal_city = $row[ 'personal_city' ];	$personal_country = $row[ 'personal_country' ];	$personal_post_code = $row[ 'personal_post_code' ];	$company_name = $row[ 'company_name' ];	$department_name = $row[ 'department_name' ];	$position = $row[ 'position' ];	$corporate_code = $row[ 'corporate_code' ];	$company_phone = $row[ 'company_phone' ];	$company_mobile = $row[ 'company_mobile' ];	$company_email_address = $row[ 'company_email_address' ];	$company_website_link = $row[ 'company_website_link' ];	$company_address_1 = $row[ 'company_address_1' ];	$company_address_2 = $row[ 'company_address_2' ];	$company_city = $row[ 'company_city' ];	$company_country = $row[ 'company_country' ];	$company_post_code = $row[ 'company_post_code' ];	$distributed_brand = $row[ 'distributed_brand' ];	if ( $row[ 'landscape' ] != null )	{		if ( $row[ 'landscape' ] )		{			$orientation = 'landscape';		}		else		{			$orientation = 'portrait';		};	};	$canvas_back = $row[ 'canvas_back' ];	$canvas_front = $row[ 'canvas_front' ];	$widgets_front = $row[ 'widgets_front' ];	$widgets_back = $row[ 'widgets_back' ];	$links_front = $row[ 'links_front' ];	$links_back = $row[ 'links_back' ];	$card_type = $row[ "card_type" ];};$settings = GetSetting( $card_id, $card_type, "visible_in_search", $conn );$link_status = "NONE";$cardLinkQuery = sprintf( "            SELECT link_status             FROM card_link             WHERE card_id_requested = '%s'            AND user_requested_by = '%s'", $card_id, $user_id );$link_query_result = mysqli_query( $conn, $cardLinkQuery );if ( !$link_query_result ){	$request_result->success = 0;	$request_result->message = $cardLinkQuery;	$request_result->err = mysqli_error( $conn );//	echo $request_result->err;}else{	//$request_result->success = 1;	while ( $link_row = mysqli_fetch_array( $link_query_result ) )	{		$link_status = $link_row[ "link_status" ];	}}$card = new CardStatusPermissions(				$card_id, $card_type, $link_status, $settings );function object_to_array( $data ){	if ( is_array( $data ) || is_object( $data ) )	{		$result = array();		foreach ( $data as $key => $value )		{			$result[ $key ] = object_to_array( $value );		}		return $result;	}	return $data;}$data = object_to_array( $card );echo json_encode( $data );