<?php/* * ANSWERS TO LINK REQUESTS */require_once('../../session_setup.php');require_once '../database_config.php';include_once('models.php');include_once('../../utilities/mail.class.php');include_once('../../utilities/request_result.php');require_once '../../ChromePhp.php';require_once('../push_notifications.php');if (!isset($_SESSION['user_id'])) {	echo 'expired';	exit;}$request_result = new Result();$mysqli_errors = array();$mysqli_success = array();$new_status = trim($_POST["link_status"]);$card_link_id = trim($_POST["card_id"]);$active_user_id = $_SESSION['user_id'];//$email = trim( $_POST[ 'email' ] );$insert_contact = false;$card_id = "";$card_type = "";$user_requested_by = "";//=============QUERY=============$query = sprintf("SELECT c.card_id,c.card_name,c.card_type,c.assigned_id,cl.user_requested_by,u.user_id,u.first_name, u.last_name, u.email_address FROM card_link cl JOIN card c ON cl.card_id_requested = c.card_id LEFT JOIN user u ON u.user_id='$active_user_id' WHERE cl.card_link = '%s'", $card_link_id);ChromePhp::log('query is ' . $query);$result = mysqli_query($conn, $query);ChromePhp::log('error: ' . mysqli_error($conn));if (!$result) {	array_push($mysqli_errors, array(		'mysqli_error' => mysqli_error($conn),		'executed_query' => $query));} else {	array_push($mysqli_success, $query);}while ($card_type_row = mysqli_fetch_array($result)) {	$card_id = $card_type_row["card_id"];	$card_type = $card_type_row["card_type"];	$card_owner = $card_type_row["first_name"] . ' ' . $card_type_row["last_name"];	$card_name = $card_type_row["card_name"];	$bcn = $card_type_row["assigned_id"];	$recipient_user_id = $card_type_row["user_requested_by"];}$query = "SELECT canvas_front FROM card_data WHERE card_id='$card_id'";$result = mysqli_query($conn, $query);$row = mysqli_fetch_row($result);$card_picture = $row[0];$query = "SELECT first_name, last_name, email_address, reg_id, profile_image FROM user WHERE user_id='$recipient_user_id'";ChromePhp::log('query is ' . $query);$result = mysqli_query($conn, $query);ChromePhp::log('error: ' . mysqli_error($conn));if ($result) {	$row = mysqli_fetch_row($result);	$recipient_name = $row[0] . ' ' . $row[1];	$recipient_email = $row[2];	$recipient_reg_id = $row[3];	$recipient_profile_image = $row[4];}ChromePhp::log('$email ' . $recipient_email);ChromePhp::log('$recipient_user_id ' . $recipient_user_id);ChromePhp::log('$recipient_name ' . $recipient_name);//mail('webintenerife@gmail.com', 'reg id', 'reg_id: '.$recipient_reg_id.'  user_id: '.$recipient_user_id);//$date = new DateTime( 'NOW' );//$date_string = $date->format( 'Y-m-d H:i:s' );$date_string = urldecode($_POST['date_string']);switch ($new_status) {	case 'REQUESTED':		//Would be weird for status to be updated to REQUESTED, but keeping for now as reference of all possible statuses//		$query = "";		break;	case 'ACCEPTED':		$answer = 'accepted';		/* add event to notifications table */		$query = "INSERT INTO notifications (notification_type, event, event_date, recipient_user_id, active_user_id) VALUES ('request_accepted', ' approved your link request','$date_string', '$recipient_user_id', '$active_user_id')";		ChromePhp::log('insert query is ' . $query);		mysqli_query($conn, $query);		ChromePhp::log('error: ' . mysqli_error($conn));		/* limiting table to 20 records per user */		$query = "SELECT COUNT(*) as total FROM notifications WHERE recipient_user_id='$recipient_user_id'";		ChromePhp::log('insert query is ' . $query);		$result = mysqli_query($conn, $query);		ChromePhp::log('error: ' . mysqli_error($conn));		if ($result) {			$row = mysqli_fetch_assoc($result);			ChromePhp::log('total is ' . $row['total']);			if ($row['total'] > 20) {				$query = "DELETE FROM `notifications` WHERE recipient_user_id='$recipient_user_id' AND id NOT IN (	SELECT id FROM (SELECT id FROM `notifications` ORDER BY id DESC	LIMIT 20) foo )";				ChromePhp::log('insert query is ' . $query);				$result = mysqli_query($conn, $query);				ChromePhp::log('error: ' . mysqli_error($conn));			}		}		$insert_contact = TRUE;		ChromePhp::log('insert_contact is true');//		$message = "Congratulations, $recipient_name! $card_owner, the owner of the card '$card_name', has accepted your request.";		break;	case 'REJECTED':		$answer = 'rejected';		//allowed		/* add event to notifications table */		$query = "INSERT INTO notifications (notification_type, event, event_date, recipient_user_id, active_user_id) VALUES ('request_rejected', 'rejected your link request','$date_string', '$recipient_user_id', '$active_user_id')";		ChromePhp::log('insert query is ' . $query);		mysqli_query($conn, $query);		ChromePhp::log('error: ' . mysqli_error($conn));		/* limiting table to 20 records per user */		$query = "SELECT COUNT(*) as total FROM notifications WHERE recipient_user_id='$recipient_user_id'";		ChromePhp::log('insert query is ' . $query);		$result = mysqli_query($conn, $query);		ChromePhp::log('error: ' . mysqli_error($conn));		if ($result) {			$row = mysqli_fetch_assoc($result);			ChromePhp::log('total is ' . $row['total']);			if ($row['total'] > 20) {				$query = "DELETE FROM `notifications` WHERE recipient_user_id='$recipient_user_id' AND id NOT IN (	SELECT id FROM (SELECT id	FROM `notifications` ORDER BY id DESC	LIMIT 20) foo )";				ChromePhp::log('insert query is ' . $query);				$result = mysqli_query($conn, $query);				ChromePhp::log('error: ' . mysqli_error($conn));			}		}//		$message = "Sorry, $recipient_name. $card_owner, the owner of the card '$card_name', has rejected your request.";		break;	case 'DELETED':		//should not redirect here		break;	default:		//TODO: any other value is not allowed, handle here		$query = "";		break;}//=============QUERY=============if ($insert_contact) {	//=============QUERY=============//	$query = sprintf( "INSERT INTO card_contact (user_id,card_id,private) values ('%s','%s',1)  On DUPLICATE KEY UPDATE user_id='%s', card_id='%s', private=1", $user_requested_by, $card_id);	$query = "INSERT INTO card_contact (user_id,card_id,private) values ('$recipient_user_id','$card_id',1)  On DUPLICATE KEY UPDATE user_id='$recipient_user_id', card_id='$card_id', private='1'";	ChromePhp::log('insert_contact query is: ' . $query);	$result = mysqli_query($conn, $query);	ChromePhp::log('error inserting in card_contact: ' . mysqli_error($conn));	if (!$result) {		array_push($mysqli_errors, array(			'mysqli_error' => mysqli_error($conn),			'executed_query' => $query));	} else {		array_push($mysqli_success, $query);	}	//=============QUERY=============}if ($card_type == "Personal" || $card_type == "Corporate") {	//=============QUERY=============	$query = "SELECT requires_reciprocity FROM personal_card_setting WHERE card_id = '" . $card_id . "'";	$result = mysqli_query($conn, $query);	if (!$result) {		array_push($mysqli_errors, array(			'mysqli_error' => mysqli_error($conn),			'executed_query' => $query));	} else {		array_push($mysqli_success, $query);	}	$requires_reciprocity = "Did not Require Reciprocity";	while ($row = mysqli_fetch_array($result)) {		$requires_reciprocity = $row["requires_reciprocity"];	}	//=============QUERY=============	if ($requires_reciprocity == "1" || $requires_reciprocity == 1) {		//TODO: make sure about which card will be inserted here		//TODO: make sure about what should happen if that person does not have any cards		//TODO: make sure about what should happen if user already has card		$opposite_card_id = "";		//=============QUERY=============		$query = sprintf("SELECT c.card_id FROM card c INNER JOIN user u on c.user_id = u.user_id and c.card_id = u.default_card WHERE c.user_id='%s'", $recipient_user_id);		$result = mysqli_query($conn, $query);		if (!$result) {			array_push($mysqli_errors, array(				'mysqli_error' => mysqli_error($conn),				'executed_query' => $query));		} else {			array_push($mysqli_success, $query);		}		while ($row = mysqli_fetch_array($result)) {			$opposite_card_id = $row["card_id"];		}		//=============QUERY=============		//=============QUERY=============		$query = sprintf("INSERT INTO card_link (user_requested_by,card_id_requested,link_status,date_requested,date_accepted,request_origin) values ('%s','%s','%s',NOW(),NOW(),'reciprocity')", $active_user_id, $opposite_card_id, "ACCEPTED");		$result = mysqli_query($conn, $query);		if (!$result) {			array_push($mysqli_errors, array(				'mysqli_error' => mysqli_error($conn),				'executed_query' => $query));		} else {			array_push($mysqli_success, $query);		}		//=============QUERY=============		$query = sprintf("INSERT INTO card_contact (user_id,card_id,private) values ('%s','%s',1)", $active_user_id, $opposite_card_id);		$result = mysqli_query($conn, $query);		if (!$result) {			array_push($mysqli_errors, array(				'mysqli_error' => mysqli_error($conn),				'executed_query' => $query));		} else {			array_push($mysqli_success, $query);		}	}}//=============QUERY=============$query = sprintf("UPDATE card_link SET link_status = '%s',date_accepted = NOW() WHERE card_link = '%s' AND user_requested_by != '%s'", $new_status, $card_link_id, $active_user_id);//mail('webintenerife@gmail.com', 'mysql data', "running $query gave error: " . mysqli_error($conn));$result = mysqli_query($conn, $query);if (!$result) {	array_push($mysqli_errors, array(		'mysqli_error' => mysqli_error($conn),		'executed_query' => $query));} else {	array_push($mysqli_success, $query);}//=============QUERY=============$request_result->errors = $mysqli_errors;$request_result->successes = $mysqli_success;/* * TODO: mysqli_errors is always > 0 because all queries are executed,  * also the ones which shouldn't be executed and so  * they push errors in mysqli_errors array */if (count($mysqli_errors) > 0) {	$request_result->success = 0;} else {	$request_result->success = 1;	$errors = serialize($mysqli_errors);}$mailer = new Mailer();$tokens = array(	'{{__RECIPIENT_FULL_NAME__}}',	'{{__RECIPIENT_PROFILE__}}',	'{{__AUTHOR_PROFILE__}}',	'{{__AUTHOR_FULL_NAME__}}',	'{{__CARD_PICTURE__}}',	'{{__CARD_NAME__}}',	'{{__ANSWER__}}',	'{{__BCN__}}',	'{{__TARGET_URL__}}');$replacements = array(	$recipient_name,	BASEURL . $recipient_profile_image,	BASEURL . $profile_image,	$card_owner,	BASEURL . $card_picture,	$card_name,	$answer,	$bcn,	BASEURL . "view_card_details.php?bcn=" . $bcn . "&card_id=" . $card_id);$raw_message = file_get_contents('../../email-templates/requests_answer/index.html');$message = str_replace($tokens, $replacements, $raw_message);$subject = "Cardition - Card linking request $answer";$mail_result = $mailer->send_mail(		"info@cardition.com", "Cardition", $recipient_email, $subject, $message);echo json_encode($request_result);//mail('webintenerife@gmail.com', 'sending push', $recipient_reg_id . ' <br>' .$message);sendPush($recipient_reg_id, $subject, $message, $card_id, $active_user_id);